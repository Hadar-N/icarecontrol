{% extends "base.html" %}
{% block body %}

<div class="fulldisplay centered center-top">

    <div id="for-table"></div>

    <div id="for-instructions"></div>

</div>

<div class="ctrl-buttons">
    {% for btn in ["home","return"] %}
    <input type="radio" name="ctrl-buttons" id="{{btn}}" value="{{btn}}" />
    <label for="{{btn}}" class="ctrl-singlebutton" id="{{btn}}" onclick="onClickControl(this)">
        <img class="ctrl-img" src="/static/icons/{{btn}}.svg" alt="{{btn}}" />
    </label>
    {% endfor %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        for_table_elm = document.getElementById('for-table');
        word_table = new WordTable(for_table_elm);

        for_instructions_elm = document.getElementById('for-instructions');
        instructions_line = new InstructionsLine(for_instructions_elm);

        strings = GameState.getStrings()["gameprocess.html"]
        data_actions = GameState.getConsts().MQTT_DATA_ACTIONS
        flow_stages = GameState.getConsts().FLOW_STAGES
        data_actions_to_flow_stage = GameState.getConsts().MQTT_DATA_ACTION_TO_FLOW_STAGE
        active_contours = 0;

        onClickControl = (obj) => {
            GameState.playClickAudio();
            clickControlFunc("stop");
            GameState.setCurrLevel(0)
            if (obj.getAttribute("id") == "home") {
                GameState.setCurrMode(0)
            }
            window.location.href = '/game/';
        }

        applyStage = (stage, word = null) => {
            word_table.RenderByStage(stage, word)
            instructions_line.applyInsructions(stage)
        }

        try {
            socket.on('word', data => {
                future_flowstage = data_actions_to_flow_stage[data.type]
                if (Number.isInteger(future_flowstage)) applyStage(future_flowstage, data.word)
                else if (data.type == data_actions.SELECT_FAIL) speakWord(strings.instructions.dig_2)
                else printInPythonTerminal('action type unaccepted:' + data.type)
            });
            socket.on("contours", data => {
                if (data.contours == 0 && !word_table.isActive()) applyStage(flow_stages.INITIAL)
                else if ((data.contours > active_contours || data.contours >= 2) && word_table.isOptionsDisplayable()) {
                    applyStage(flow_stages.BOTH_CONTOURS_READY)
                }
                active_contours = data.contours
            })
        } catch (err) {
            console.log("word change err: ", err)
        }
    });
</script>

{% endblock %}