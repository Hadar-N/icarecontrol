<html>

<head>
    <title>iCare Control</title>
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />

    <script>

        function clickFunc(elm) {
            fetch('/publish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: elm.getAttribute("command") })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.redirect) window.location.href = data.redirect;
                })
        }

        function createListItem(word) {
            const li = document.createElement('li');
            li.id = `w-${word}`
            li.textContent = word;
            const svg = document.createElement('img');
            svg.src = "static/icons/speaker.svg";
            li.appendChild(svg)
            return li;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const evtSource = new EventSource("/stream");

            const startBtn = document.getElementById('start');
            startBtn.checked = true;

            const messagesList = document.getElementById('message-list');

            evtSource.onmessage = function (event) {
                const newMessages = JSON.parse(event.data);
                newMessages.forEach(message => {
                    message_obj = JSON.parse(message);
                    if (message_obj.status) console.log("STATUS CHANGE!!!", typeof message_obj.status, message_obj.status)
                    message_obj.new?.forEach(new_msg => {
                        messagesList.prepend(createListItem(new_msg.en));
                    });
                    message_obj.remove?.forEach(rem_msg => {
                        document.getElementById(`w-${rem_msg.en}`).remove()
                    })
                    message_obj.matched?.forEach(mat_msg => {
                        document.getElementById(`w-${mat_msg.en}`).classList.add("matched")
                    })
                })
            };

            evtSource.onerror = function (err) {
                console.error("EventSource failed:", err);
            };
        });
    </script>

</head>

<body>

    <div class="fulldisplay centered center-top">

        <div class="top-bar centered">
            <div>game running</div>
            <div class="level-name">level: {{level}}</div>
        </div>

        <div class="listed">
            <h3 class="list-title">Messages:</h3>
            <ul id="message-list"></ul>
        </div>

    </div>

    <div class="ctrl-buttons">
        {% for btn in btns %}
        <input type="radio" name="ctrl-buttons" id="{{btn.value}}" value="{{btn.value}}" />
        <label for="{{btn.value}}" class="ctrl-singlebutton" command="{{btn.value}}" onclick="clickFunc(this)">
            <img class="ctrl-img" src="static/icons/{{btn.value}}.svg" alt="{{btn.value}}" />
        </label>
        {% endfor %}
    </div>


</body>

</html>